/*
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2015 - 2019, Ginkgo
 * @license     http://opensource.org/licenses/MIT  MIT License
 * @link        https://www.ioa.tw/
 */

var e=["AIzaSyBF02Xytwx2peyWWpiUwkQDgng_FYmnBaA"],T={lat:23.77133806905457,lng:120.70937982351438},n=!1,t=!1,_=null,k=null,x=null,C=null,M=null,P=null,L=null,N=[],I=[],z=[],j=[],O=[],S=!1,A=["#f5c801","#fbbb03","#fcab0a","#fc9913","#fb871d","#fa7226","#f95d30","#f94739","#f93748","#f72b5e"],B=64e3;function D(){return(new Date).getTime()}function H(t){this._div=null,this._option=Object.assign({className:"",top:0,left:0,width:32,height:32,html:"",map:null,position:null,css:{}},t),this._option.map&&this.setMap(this._option.map)}function U(){H.prototype=new google.maps.OverlayView,Object.assign(H.prototype,{setPoint:function(){if(this._div){if(!this._option.position)return this._div.style.left="-999px",void(this._div.style.top="-999px");if(this.getProjection()){var t=this.getProjection().fromLatLngToDivPixel(this._option.position);t&&(this._div.style.left=t.x-this._option.width/2+this._option.left+"px",this._div.style.top=t.y-this._option.height/2+this._option.top+"px")}}},draw:function(){this.setPoint()},onAdd:function(){for(var t in this._div=document.createElement("div"),this._div.style.position="absolute",this._div.className=this._option.className,this._div.style.width=this._option.width+"px",this._div.style.height=this._option.height+"px",this._div.innerHTML=this._option.html,this._option.css)"width"!=t&&"height"!=t&&"top"!=t&&"left"!=t&&"bottom"!=t&&"right"!=t&&(this._div.style[t]=this._option.css[t]);var e=this;google.maps.event.addDomListener(this._div,"click",function(t){t.stopPropagation&&t.stopPropagation(),google.maps.event.trigger(e,"click")}),this.getPanes().overlayImage.appendChild(this._div)},remove:function(){return this._div&&(this._div.parentNode.removeChild(this._div),this._div=null),this},setHtml:function(t){return this._option.html=t,this._div&&(this._div.innerHTML=this._option.html),this},getClassName:function(){return this._option.className},setClassName:function(t){return this._option.className=t,this._div&&(this._div.className=this._option.className),this},setPosition:function(t){return this.map&&(this._option.position=t,this.setPoint()),this},getPosition:function(){return this._option.position}})}function W(t){return new google.maps.LatLng(t[0].lat,t[0].lng)}function J(t){return t.map&&t.setMap(null),null}function E(t){return null!==t}function i(t,e){for(var n=[],i=0;i<t.length;i++)void 0===n[parseInt(i/e,10)]?n[parseInt(i/e,10)]=[t[i]]:n[parseInt(i/e,10)][i%e]=t[i];return n}function o(){t||(t=!0,T=W([T]),_&&_())}function F(){if(!n){n=!0,$(window).bind("gm",o);var t=e[Math.floor(Math.random()*e.length)];return $.getScript("https://maps.googleapis.com/maps/api/js?"+(t?"key="+t+"&":"")+"language=zh-TW&libraries=visualization&callback=gmc",o),!0}}function R(t,e,n,i,o){if(!t.length)return o?o([]):[];for(var l={},a=[],s=0;s<t.length;s++)if(void 0===l[s]){l[s]=!0;for(var r=[t[s]],u=s+1;u<t.length;u++)if(void 0===l[u]){var p=Math.max(Math.abs(t[s].lat-t[u].lat),Math.abs(t[s].lng-t[u].lng));if(30/Math.pow(2,e)/n<=p){if(i)break}else l[u]=!0,r.push(t[u])}else if(i)break;a.push(r)}return l=null,o?o(a):a}window.gmc=function(){$(window).trigger("gm")},$(function(){function t(t,e){return u.hide(function(){o.empty().append($("<div />").attr("id","map").attr("data-emoticons",t).attr("data-error",e))})}function n(t){if(O=O.map(J).filter(E),I=I.map(J).filter(E),j=j.map(J).filter(E),!N.length)return null!==C&&C.setMap(null),t&&t();null===C&&(C=new H({map:k,width:44,height:72,top:-28,className:"nowMarker",html:"<div><span style='background-image: url(/img/icon2-64-tiny.png)'></span></div>"})),C.setPosition(new google.maps.LatLng(N[0].lat,N[0].lng)),I=R(N,k.zoom,1,!0).map(function(t){var e=new H({map:k,position:W(t),width:14,height:14,className:"signalMarker speed"+t[0].speed+" course"+t[0].course,html:"<span></span>"});return e.speed=t[0].speed,e});for(var e=1;e<I.length;e++)O.push(new google.maps.Polyline({map:k,strokeWeight:5,strokeColor:A[I[e-1].speed-1],path:[I[e-1].getPosition(),I[e].getPosition()]}));return j=R(z,k.zoom,1,!0).map(function(t){var e=new H({map:k,position:W(t),width:24,height:24,className:"stopMarker",html:"<div cnt='"+t.length+"'><span data-title=\"停留了 "+w(t[0].elapsed)+'"></span></div>'});return e.addListener("click",function(){e.setClassName("stopMarker show"==e.getClassName()?"stopMarker":"stopMarker show")}),e}),t&&t()}function i(e){if(!S)return S=!0,$.get("/json/"+a.val.bo+".json?t="+D(),function(t){return N=t.signals,z=t.stops,y.data(t.title),g.data(t.speeds),h.data(t.stops.length),m.data(t.length),c.data(w(t.elapsed)),f.data(b(t.updateAt)),v.data(t.enable),t.enable||(clearInterval(L),L=null),e?e():n()}).fail(t.bind(null,"(ಥ﹏ಥ)","哭哭，取不到資料！")).always(function(){S=!1})}var o=$("body"),l=$("#map"),a={val:{},init:function(){return window.location.search.replace(/^\?/,"").split("&").forEach(function(t){var e=t.split("=");if(2==e.length){var n=decodeURIComponent(e[0]),i=decodeURIComponent(e[1]);"[]"==n.slice(-2)?this.val[n=n.slice(0,-2)]?this.val[n].push(i):this.val[n]=[i]:this.val[n]=i}}.bind(this)),this.val.bo=void 0!==this.val.bo&&this.val.bo.length?this.val.bo:null,this}}.init(),s={exist:function(){return void 0!==s&&"undefined"!=typeof JSON},set:function(t,e){if(!this.exist())return!1;try{return localStorage.setItem(t,void 0===e?null:JSON.stringify(e)),!0}catch(t){return!1}},get:function(t){return!!this.exist()&&(val=localStorage.getItem(t),JSON.parse(val))}},r={key:"gps.kerker.tw",ttl:6e5,data:{},timeout:5e3,fail:null,get:function(e,n,t){var i=s.get(r.key);return i&&"object"==typeof i&&"number"==typeof i.t&&"object"==typeof i.v&&i.t+r.ttl>D()?n&&n(r.data=i.v):(setTimeout(function(){if(!1!==r.fail)return r.fail=!0,t&&t()},r.timeout),navigator.geolocation.getCurrentPosition(function(t){!0!==r.fail&&(r.fail=!1,r.data={lat:t.coords.latitude,lng:t.coords.longitude,acc:t.coords.accuracy},s.set(r.key,{t:D(),v:r.data}),e&&e(r.data),n&&n(r.data))},t,{enableHighAccuracy:!0}))}},u={$el:null,$el2:null,timer:null,init:function(){null===u.$el&&(u.$el=$("<div />").attr("id","loading").appendTo(o),u.$el2=$("<span />").appendTo(u.$el))},remove:function(){null!==u.$el&&u.$el.remove(),null!==u.$el2&&u.$el2.remove()},show:function(t,e){return u.init(),u.$el2.text(t),u.$el.addClass("show"),u.timer=setTimeout(function(){u.$el.addClass("ani"),setTimeout(function(){clearTimeout(u.timer),u.timer=null},300),e&&e()},100)},hide:function(t){function e(){return clearTimeout(u.timer),u.timer=null,u.$el.removeClass("ani"),setTimeout(function(){u.$el.removeClass("show"),u.remove(),t&&t()},300)}null!==u.timer?setTimeout(e,500):e()}},p={$el:null,$el2:null,$el3:null,init:function(){null===p.$el&&(p.$el=$("<div />").attr("id","zoom").appendTo(o),p.$el2=$("<label />").attr("id","zoomIn").click(function(){k.setZoom(k.zoom+1)}).appendTo(p.$el),p.$el3=$("<label />").attr("id","zoomOut").click(function(){k.setZoom(k.zoom-1)}).appendTo(p.$el))},show:function(t){return p.init(),setTimeout(function(){return p.$el.addClass("show"),t&&t()},100)}},d={$el:null,init:function(){if(null===d.$el)return d.$el=$("<label />").attr("id","at").click(function(){if(null===x&&(x=new H({map:k,width:16,height:16,className:"myMarker",html:""})),x.setPosition(new google.maps.LatLng(r.data.lat,r.data.lng)),I.length){var t=new google.maps.LatLngBounds;for(var e in t.extend(x.getPosition()),I)t.extend(I[e].getPosition());k.fitBounds(t)}else k.setOptions({center:x.getPosition()})}).appendTo(o)},show:function(t){return r.get(null,function(){return d.init(),setTimeout(function(){return d.$el.addClass("show"),t&&t()},100)},t)}},f={$el:null,init:function(){return null===f.$el?f.$el=$("<div />").attr("id","updateAt").appendTo(o):f.$el.empty()},data:function(t){return f.init().text(t)},show:function(t){return setTimeout(function(){return f.$el.addClass("show"),t&&t()},100)}},c={$el:null,init:function(){return null===c.$el?c.$el=$("<div />").attr("id","elapsed").appendTo(o):c.$el.empty()},data:function(t){return c.init().text(t)},show:function(t){return setTimeout(function(){return c.$el.addClass("show"),t&&t()},100)}},h={$el:null,init:function(){return null===h.$el?h.$el=$("<div />").attr("id","stops").appendTo(o):h.$el.empty()},data:function(t){return h.init().text(t)},show:function(t){return setTimeout(function(){return h.$el.addClass("show"),t&&t()},100)}},m={$el:null,init:function(){return null===m.$el?m.$el=$("<div />").attr("id","length").appendTo(o):m.$el.empty()},data:function(t){return m.init().text(t)},show:function(t){return setTimeout(function(){return m.$el.addClass("show"),t&&t()},100)}},g={$el:null,init:function(){return null===g.$el?g.$el=$("<div />").attr("id","speeds").appendTo(o).click(function(){$(this).toggleClass("click")}):g.$el.empty()},data:function(t){return g.init().append(t.map(function(t){return $("<b />").text(t)})).attr("n",t.length)},show:function(t){return setTimeout(function(){return g.$el.addClass("show"),t&&t()},100)}},v={$el:null,init:function(){return null===v.$el?v.$el=$("<div />").attr("id","status").appendTo(o):v.$el.empty()},data:function(t){return v.init().attr("status",t)},show:function(t){return setTimeout(function(){return v.$el.addClass("show"),t&&t()},100)}},y={$el:null,ori:"",init:function(){return null!==y.$el||(y.$el=$("title"),y.ori=y.$el.text(),y.ori=0<y.ori.length?" | "+y.ori:""),y.$el.empty()},data:function(t){return y.init().text(t+y.ori)},show:function(t){return t&&t()}},w=function(t){if(0===t)return"瞬間…";var e=[],n=[{base:60,format:"秒"},{base:60,format:"分鐘"},{base:24,format:"小時"},{base:30,format:"天"},{base:12,format:"個月"}];for(var i in n){var o=t%n[i].base;if(0!=o&&e.push(o+n[i].format),(t=Math.floor(t/n[i].base))<1)break}return 0<t&&e.push(t+"年"),e.length<1&&e.push(t+"秒"),e.reverse().join(" ")},b=function(t){for(var e=D()/1e3-t,n=[{base:10,format:"剛剛"},{base:6,format:"不到 1 分鐘"},{base:60,format:" 分鐘前"},{base:24,format:" 小時前"},{base:30,format:" 天前"},{base:12,format:" 個月前"}],i=1,o=0,l=0;l<n.length;l++,i=o)if(e<(o=n[l].base*i))return(1<l?parseInt(e/i,10):"")+n[l].format;return parseInt(e/i,10)+" 年前"};_=function(){if(!k){if(k=new google.maps.Map(l.get(0),{zoom:7,clickableIcons:!1,disableDefaultUI:!0,gestureHandling:"greedy",center:T}),U(),k.mapTypes.set("ms",new google.maps.StyledMapType([{stylers:[{gamma:0},{weight:.75}]},{featureType:"all",stylers:[{visibility:"on"}]},{featureType:"administrative",stylers:[{visibility:"on"}]},{featureType:"landscape",stylers:[{visibility:"on"}]},{featureType:"poi",stylers:[{visibility:"on"}]},{featureType:"road",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{visibility:"on"}]},{featureType:"transit",stylers:[{visibility:"on"}]},{featureType:"water",stylers:[{color:"#b3d1ff",visibility:"on"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]}])),k.setMapTypeId("ms"),2<=N.length){var t=new google.maps.LatLngBounds;for(var e in N)t.extend(new google.maps.LatLng(N[e].lat,N[e].lng));k.fitBounds(t)}p.show(function(){d.show(),f.show(function(){y.show(function(){v.show(function(){g.show(function(){c.show(function(){m.show(function(){h.show(function(){u.hide(function(){n(function(){P=k.zoom,k.addListener("idle",function(){k.zoom!==P&&(P=k.zoom,clearTimeout(M),M=setTimeout(n,300))}),L=setInterval(i,B)})})})})})})})})})})}},u.show("初始中…",null===a.val.bo?t.bind(null,"ʕ•ᴥ•ʔ","您沒有權限看喔！"):i.bind(null,F))});